name: Build

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure npm registry
        run: npm config set registry https://registry.npmjs.org/

      - name: Install dependencies
        run: npm ci

      - name: Fetch published version
        id: published
        run: |
          set +e
          published=$(npm view "local-search-mcp" version 2>/dev/null)
          status=$?
          set -e
          if [ $status -ne 0 ]; then
            published=""
          fi
          echo "version=$published" >> "$GITHUB_OUTPUT"

      - name: Determine next version
        id: version
        env:
          PUBLISHED_VERSION: ${{ steps.published.outputs.version }}
        run: node scripts/bump-version.js

      - name: Run build
        run: npm run build

      - name: Create package tarball
        id: pack
        run: |
          mkdir -p dist
          tarball=$(npm pack --json --ignore-scripts | jq -r '.[0].filename')
          mv "$tarball" dist/
          echo "tarball=$tarball" >> "$GITHUB_OUTPUT"
          echo "${{ steps.version.outputs.version }}" > dist/version.txt
          echo "$tarball" > dist/tarball.txt

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: dist
